<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quáº£n lÃ½ tin nháº¯n - LOTUS</title>
    <link rel="stylesheet" href="stylemess.css">
</head>

<body>
    <header>
        <div class="logo"></div>
        <span>LOTUS</span>
        <a href="/logout" class="btn-logout">ÄÄƒng xuáº¥t</a>
    </header>

    <main id="messagesContainer">
        <!-- Tin nháº¯n sáº½ load báº±ng JS -->
    </main>
    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io(); // Káº¿t ná»‘i tá»›i server socket.io
        /** escape HTML Ä‘á»ƒ trÃ¡nh XSS khi hiá»ƒn thá»‹ */
        socket.on("newMessage", (msg) => {
            let container = document.getElementById("messagesContainer");
            let card = document.createElement("div");
            card.className = "message-card";
            card.innerHTML = `
  <div class="sender">ğŸ‘¤ ${escapeHtml(msg.sender || "áº¨n danh")}</div>
  <div class="time">ğŸ•’ ${formatDateFromSQL(msg.created_at)}</div>
  <div class="content">${escapeHtml(msg.content)}</div>
`;
            container.prepend(card); // thÃªm tin nháº¯n má»›i lÃªn Ä‘áº§u
        });
        function escapeHtml(str) {
            if (str === null || str === undefined) return '';
            return String(str).replace(/[&<>"']/g, function (s) {
                return ({
                    '&': '&amp;',
                    '<': '&lt;',
                    '>': '&gt;',
                    '"': '&quot;',
                    "'": '&#39;'
                })[s];
            });
        }

        /** Format ngÃ y tá»« chuá»—i SQL/ISO theo "HH:MM DD/MM/YYYY" mÃ  KHÃ”NG thay Ä‘á»•i mÃºi giá» */
        function formatDateFromSQL(sqlDate) {
            if (!sqlDate) return '';
            // náº¿u lÃ  Date object -> fallback xá»­ lÃ½
            if (sqlDate instanceof Date) {
                return sqlDate.toLocaleString('vi-VN', {
                    hour: '2-digit', minute: '2-digit',
                    day: '2-digit', month: '2-digit', year: 'numeric',
                    hour12: false, timeZone: 'Asia/Ho_Chi_Minh'
                });
            }
            const s = String(sqlDate);
            // match "YYYY-MM-DDTHH:MM(:SS)?" (works whether there's 'Z' hay +00:00)
            const m = s.match(/^(\d{4})-(\d{2})-(\d{2})T(\d{2}):(\d{2})(?::\d{2})?/);
            if (m) {
                const [, Y, Mo, D, H, Mi] = m;
                return `${H}:${Mi} ${D}/${Mo}/${Y}`; // vÃ­ dá»¥: "14:05 08/09/2025"
            }
            // fallback an toÃ n
            try {
                return new Date(s).toLocaleString('vi-VN', {
                    hour: '2-digit', minute: '2-digit',
                    day: '2-digit', month: '2-digit', year: 'numeric',
                    hour12: false, timeZone: 'Asia/Ho_Chi_Minh'
                });
            } catch (e) {
                return s;
            }
        }

        /** Táº£i danh sÃ¡ch tin nháº¯n vÃ  render thÃ nh cÃ¡c card */
        async function loadMessages() {
            try {
                const res = await fetch("/api/messages");
                if (!res.ok) throw new Error('Fetch /api/messages lá»—i: ' + res.status);
                const data = await res.json();

                const container = document.getElementById("messagesContainer");
                container.innerHTML = data.map(m => `
      <div class="message-card" data-id="${m.id}">
        <div class="sender">ğŸ‘¤ ${escapeHtml(m.sender || "áº¨n danh")}</div>
        <div class="time">ğŸ•’ ${escapeHtml(formatDateFromSQL(m.created_at))}</div>
        <div class="content">${escapeHtml(m.content)}</div>
        <button class="btn-delete" data-id="${m.id}">XÃ³a</button>
      </div>
    `).join("");
            } catch (err) {
                console.error("Lá»—i load tin nháº¯n:", err);
            }
        }

        /** XÃ³a tin nháº¯n (gá»i API DELETE) + remove card ngay náº¿u thÃ nh cÃ´ng */
        async function deleteMessage(id) {
            if (!confirm("Báº¡n cÃ³ cháº¯c muá»‘n xÃ³a tin nháº¯n nÃ y?")) return;
            try {
                const res = await fetch(`/api/messages/${id}`, { method: "DELETE" });
                if (res.ok) {
                    const el = document.querySelector(`.message-card[data-id="${id}"]`);
                    if (el) el.remove();
                } else {
                    const text = await res.text();
                    alert("KhÃ´ng thá»ƒ xÃ³a: " + text);
                }
            } catch (err) {
                console.error("Lá»—i xÃ³a:", err);
                alert("Lá»—i khi xÃ³a tin nháº¯n");
            }
        }

        /** á»¦y quyá»n event click cho nÃºt XÃ³a (delegation) */
        document.getElementById('messagesContainer').addEventListener('click', function (e) {
            const btn = e.target.closest('.btn-delete');
            if (!btn) return;
            const id = btn.dataset.id;
            deleteMessage(id);
        });

        // load láº§n Ä‘áº§u, sau Ä‘Ã³ poll má»—i 2 giÃ¢y
        loadMessages();
        setInterval(loadMessages, 2000);
    </script>

</body>

</html>