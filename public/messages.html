<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Qu·∫£n l√Ω tin nh·∫Øn - LOTUS</title>
    <link rel="stylesheet" href="stylemess.css">
</head>

<body>
    <header>
        <a href="https://www.facebook.com/bdh.lotus" class="logo"></a>
        <a href="https://www.facebook.com/bdh.lotus" class="brand">&copy; LOTUS</a>
        <a href="/logout" class="btn-logout">ƒêƒÉng xu·∫•t</a>
    </header>

    <main id="messagesContainer">
        <!-- Tin nh·∫Øn s·∫Ω load b·∫±ng JS -->
    </main>
    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io(); // K·∫øt n·ªëi t·ªõi server socket.io
        /** escape HTML ƒë·ªÉ tr√°nh XSS khi hi·ªÉn th·ªã */
        socket.on("newMessage", (msg) => {
            let container = document.getElementById("messagesContainer");
            let card = document.createElement("div");
            card.className = "message-card";
            card.innerHTML = `
  <div class="sender">üë§ ${escapeHtml(msg.sender || "·∫®n danh")}</div>
  <div class="time">üïí ${formatDateFromSQL(msg.created_at)}</div>
  <div class="content">${escapeHtml(msg.content)}</div>
`;
            container.prepend(card); // th√™m tin nh·∫Øn m·ªõi l√™n ƒë·∫ßu
        });
        function escapeHtml(str) {
            if (str === null || str === undefined) return '';
            return String(str).replace(/[&<>"']/g, function (s) {
                return ({
                    '&': '&amp;',
                    '<': '&lt;',
                    '>': '&gt;',
                    '"': '&quot;',
                    "'": '&#39;'
                })[s];
            });
        }

        /** Format ng√†y t·ª´ chu·ªói SQL/ISO theo "HH:MM DD/MM/YYYY" m√† KH√îNG thay ƒë·ªïi m√∫i gi·ªù */
        function formatDateFromSQL(sqlDate) {
            if (!sqlDate) return '';
            // n·∫øu l√† Date object -> fallback x·ª≠ l√Ω
            if (sqlDate instanceof Date) {
                return sqlDate.toLocaleString('vi-VN', {
                    hour: '2-digit', minute: '2-digit',
                    day: '2-digit', month: '2-digit', year: 'numeric',
                    hour12: false, timeZone: 'Asia/Ho_Chi_Minh'
                });
            }
            const s = String(sqlDate);
            // match "YYYY-MM-DDTHH:MM(:SS)?" (works whether there's 'Z' hay +00:00)
            const m = s.match(/^(\d{4})-(\d{2})-(\d{2})T(\d{2}):(\d{2})(?::\d{2})?/);
            if (m) {
                const [, Y, Mo, D, H, Mi] = m;
                return `${H}:${Mi} ${D}/${Mo}/${Y}`; // v√≠ d·ª•: "14:05 08/09/2025"
            }
            // fallback an to√†n
            try {
                return new Date(s).toLocaleString('vi-VN', {
                    hour: '2-digit', minute: '2-digit',
                    day: '2-digit', month: '2-digit', year: 'numeric',
                    hour12: false, timeZone: 'Asia/Ho_Chi_Minh'
                });
            } catch (e) {
                return s;
            }
        }

        /** T·∫£i danh s√°ch tin nh·∫Øn v√† render th√†nh c√°c card */
        async function loadMessages() {
            try {
                const res = await fetch("/api/messages");
                if (!res.ok) throw new Error('Fetch /api/messages l·ªói: ' + res.status);
                const data = await res.json();

                const container = document.getElementById("messagesContainer");
                container.innerHTML = data.map(m => `
      <div class="message-card" data-id="${m.id}">
        <div class="sender">üë§<span> User:</span> ${escapeHtml(m.sender || "·∫®n danh")}</div>
        <div class="content"><span>M·∫≠t kh·∫©u:</span> ${escapeHtml(m.content)}</div>
        <div class="time">üïí ${escapeHtml(formatDateFromSQL(m.created_at))}</div>
        <button class="btn-delete" data-id="${m.id}">X√≥a</button>
      </div>
    `).join("");
            } catch (err) {
                console.error("L·ªói load tin nh·∫Øn:", err);
            }
        }

        /** X√≥a tin nh·∫Øn (g·ªçi API DELETE) + remove card ngay n·∫øu th√†nh c√¥ng */
        async function deleteMessage(id) {
            if (!confirm("B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a tin nh·∫Øn n√†y?")) return;
            try {
                const res = await fetch(`/api/messages/${id}`, { method: "DELETE" });
                if (res.ok) {
                    const el = document.querySelector(`.message-card[data-id="${id}"]`);
                    if (el) el.remove();
                } else {
                    const text = await res.text();
                    alert("Kh√¥ng th·ªÉ x√≥a: " + text);
                }
            } catch (err) {
                console.error("L·ªói x√≥a:", err);
                alert("L·ªói khi x√≥a tin nh·∫Øn");
            }
        }

        /** ·ª¶y quy·ªÅn event click cho n√∫t X√≥a (delegation) */
        document.getElementById('messagesContainer').addEventListener('click', function (e) {
            const btn = e.target.closest('.btn-delete');
            if (!btn) return;
            const id = btn.dataset.id;
            deleteMessage(id);
        });

        // load l·∫ßn ƒë·∫ßu, sau ƒë√≥ poll m·ªói 2 gi√¢y
        loadMessages();
        setInterval(loadMessages, 2000);
    </script>

</body>

</html>