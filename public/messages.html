<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quản lý tin nhắn - LOTUS</title>
    <link rel="stylesheet" href="stylemess.css">
</head>

<body>
    <header>
        <div class="logo"></div>
        <span>LOTUS</span>
        <a href="/logout" class="btn-logout">Đăng xuất</a>
    </header>

    <main id="messagesContainer">
        <!-- Tin nhắn sẽ load bằng JS -->
    </main>
    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io(); // Kết nối tới server socket.io
        /** escape HTML để tránh XSS khi hiển thị */
        socket.on("newMessage", (msg) => {
            let container = document.getElementById("messagesContainer");
            let card = document.createElement("div");
            card.className = "message-card";
            card.innerHTML = `
  <div class="sender">👤 ${escapeHtml(msg.sender || "Ẩn danh")}</div>
  <div class="time">🕒 ${formatDateFromSQL(msg.created_at)}</div>
  <div class="content">${escapeHtml(msg.content)}</div>
`;
            container.prepend(card); // thêm tin nhắn mới lên đầu
        });
        function escapeHtml(str) {
            if (str === null || str === undefined) return '';
            return String(str).replace(/[&<>"']/g, function (s) {
                return ({
                    '&': '&amp;',
                    '<': '&lt;',
                    '>': '&gt;',
                    '"': '&quot;',
                    "'": '&#39;'
                })[s];
            });
        }

        /** Format ngày từ chuỗi SQL/ISO theo "HH:MM DD/MM/YYYY" mà KHÔNG thay đổi múi giờ */
        function formatDateFromSQL(sqlDate) {
            if (!sqlDate) return '';
            // nếu là Date object -> fallback xử lý
            if (sqlDate instanceof Date) {
                return sqlDate.toLocaleString('vi-VN', {
                    hour: '2-digit', minute: '2-digit',
                    day: '2-digit', month: '2-digit', year: 'numeric',
                    hour12: false, timeZone: 'Asia/Ho_Chi_Minh'
                });
            }
            const s = String(sqlDate);
            // match "YYYY-MM-DDTHH:MM(:SS)?" (works whether there's 'Z' hay +00:00)
            const m = s.match(/^(\d{4})-(\d{2})-(\d{2})T(\d{2}):(\d{2})(?::\d{2})?/);
            if (m) {
                const [, Y, Mo, D, H, Mi] = m;
                return `${H}:${Mi} ${D}/${Mo}/${Y}`; // ví dụ: "14:05 08/09/2025"
            }
            // fallback an toàn
            try {
                return new Date(s).toLocaleString('vi-VN', {
                    hour: '2-digit', minute: '2-digit',
                    day: '2-digit', month: '2-digit', year: 'numeric',
                    hour12: false, timeZone: 'Asia/Ho_Chi_Minh'
                });
            } catch (e) {
                return s;
            }
        }

        /** Tải danh sách tin nhắn và render thành các card */
        async function loadMessages() {
            try {
                const res = await fetch("/api/messages");
                if (!res.ok) throw new Error('Fetch /api/messages lỗi: ' + res.status);
                const data = await res.json();

                const container = document.getElementById("messagesContainer");
                container.innerHTML = data.map(m => `
      <div class="message-card" data-id="${m.id}">
        <div class="sender">👤 ${escapeHtml(m.sender || "Ẩn danh")}</div>
        <div class="time">🕒 ${escapeHtml(formatDateFromSQL(m.created_at))}</div>
        <div class="content">${escapeHtml(m.content)}</div>
        <button class="btn-delete" data-id="${m.id}">Xóa</button>
      </div>
    `).join("");
            } catch (err) {
                console.error("Lỗi load tin nhắn:", err);
            }
        }

        /** Xóa tin nhắn (gọi API DELETE) + remove card ngay nếu thành công */
        async function deleteMessage(id) {
            if (!confirm("Bạn có chắc muốn xóa tin nhắn này?")) return;
            try {
                const res = await fetch(`/api/messages/${id}`, { method: "DELETE" });
                if (res.ok) {
                    const el = document.querySelector(`.message-card[data-id="${id}"]`);
                    if (el) el.remove();
                } else {
                    const text = await res.text();
                    alert("Không thể xóa: " + text);
                }
            } catch (err) {
                console.error("Lỗi xóa:", err);
                alert("Lỗi khi xóa tin nhắn");
            }
        }

        /** Ủy quyền event click cho nút Xóa (delegation) */
        document.getElementById('messagesContainer').addEventListener('click', function (e) {
            const btn = e.target.closest('.btn-delete');
            if (!btn) return;
            const id = btn.dataset.id;
            deleteMessage(id);
        });

        // load lần đầu, sau đó poll mỗi 2 giây
        loadMessages();
        setInterval(loadMessages, 2000);
    </script>

</body>

</html>